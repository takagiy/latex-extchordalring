\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{extchordalring}[2020/9/23 v0.3.0]
\RequirePackage{xparse}
\RequirePackage{xstring}
\RequirePackage{trimspaces}
\RequirePackage{tikz}
\RequirePackage{listofitems}

\DeclareOption{noprefix}{\newcommand\CR{\xcrCR}}
\ProcessOptions\relax

\NewDocumentCommand\xcrNodeStyle{m}{
  \tikzset{xcrNode/.style={#1}}
}

\xcrNodeStyle{
  shape=circle,
  fill=black,
}

\NewDocumentCommand\xcrCR{r()o}{
  \IfSubStr{#1}{,} {
    \xcr@CR@detail#1\relax#2\relax
  } {
    \xcr@CR@detail#1,\relax#2\relax
  }
}

\def\xcr@CR@detail#1,#2\relax#3\relax{
  \pgfmathsetmacro{\xcr@before@n}{#1-1}
  \draw \foreach \xcr@i in {0,...,\xcr@before@n} {
    (90-\xcr@i*360/#1:2) node[xcrNode] (\xcr@i) {}
    
    (90-\xcr@i*360/#1:2.5) node {\xcr@i}

    \IfNoValueT{#3} {
      (\xcr@i) -- ({90-(\xcr@i+1)*360/#1}:2)

      \foreach \xcr@j[
        evaluate=\xcr@j = \trim@spaces{\xcr@j}
      ] in {#2} {
        (\xcr@i) -- ({90-(\xcr@i+\xcr@j)*360/#1}:2)
      }
    }
  };
  \IfNoValueF{#3} {
    \foreach \xcr@path@nodes in {#3} {
      \xcr@draw@edges\xcr@path@nodes\relax
    }
  }
}

\def\xcr@draw@edges#1\relax{
  \IfSubStr{#1}{adj}
    {\xcr@connect@neighbors#1\relax}
    {\xcr@connect@path#1\relax}
}

\def\xcr@connect@path#1\relax{
  \xcr@foreachitem \xcr@node \in #1\splitby{ } {
    \ifnum\xcr@nodecnt>1
      \draw (\xcr@prev@node) -- (\xcr@node);
    \fi
    \edef\xcr@prev@node{\xcr@node}
  }
}

\def\xcr@connect@neighbors#1\relax{
  \edef\xcr@args{#1}
  \expandafter\xcr@connect@neighbors@detail\xcr@args\relax
}

\def\xcr@connect@neighbors@detail#1adj#2\relax{
  \xcr@foreachitem \xcr@node \in #2\splitby{ } {
    \draw (\trim@spaces{#1}) -- (\xcr@node);
  }
}

\def\xcr@foreachitem#1\in#2\splitby#3#4{
  \xcr@if@not@empty#2
    \setsepchar{#3}
    \readlist*\xcr@foreachitem@list{#2}
    \def\xcr@foreachitem@foreachitem##1\relax{%
      \foreachitem#1\in\xcr@foreachitem@list{
        \ifx#1\empty
        \else
        ##1
        \fi
      }%
    }
    \expandafter\xcr@foreachitem@foreachitem#4\relax
  \fi
}

\def\xcr@if@not@empty#1{
  \edef\xcr@args{\trim@spaces{#1}}
  \ifx\xcr@args\empty\else
}
